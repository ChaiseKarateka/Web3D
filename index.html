<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TP Web3D</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras/dist/aframe-extras.min.js"></script>
    
  </head>
  
  <body style="margin:0; overflow:hidden;">
    
    <a-scene physics="debug: true">
      
      <a-assets>
        <img id="sky" src="sky.jpg">
        <img id="grass" src="grass.jpg">
      </a-assets>
      
      <a-sky src="#sky"></a-sky>
      
      <a-plane position="0 0 0" rotation="-90 0 0" width="400" height="400" src="#grass" static-body></a-plane>

      <html>
  <head>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system/dist/aframe-physics-system.min.js"></script>
  </head>
  <body>
    <a-scene physics="gravity: -9.8" debug="true">
      <!-- Sol -->
      <a-plane rotation="-90 0 0" width="20" height="20" color="green" static-body></a-plane>

      <!-- Joueur -->
      <a-box id="player"
             color="red"
             width="1" height="1" depth="1"
             position="0 0.5 0"
             dynamic-body
             cube-controls>
      </a-box>

      <!-- Caméra enfant du joueur -->
      <a-entity id="camrig" position="0 1.5 0">
        <a-camera look-controls></a-camera>
      </a-entity>
    </a-scene>

    <script>
      AFRAME.registerComponent('cube-controls', {
        schema: {
          maxSpeed: {type: 'number', default: 5},
          accel: {type: 'number', default: 0.2},
          decel: {type: 'number', default: 0.1},
          jump: {type: 'number', default: 5}
        },
        init: function () {
          this.keys = {};
          this.velocity = new THREE.Vector3(0, 0, 0);
          this.canJump = false;
          this.cam = document.querySelector('#camrig');

          window.addEventListener('keydown', e => this.keys[e.code] = true);
          window.addEventListener('keyup', e => this.keys[e.code] = false);

          this.el.addEventListener('collide', e => {
            if (e.detail.contact.ni.y > 0.5) this.canJump = true;
          });
        },
        tick: function () {
          const body = this.el.body;
          if (!body) return;

          // vecteur direction selon touches
          let dir = new THREE.Vector3();
          if (this.keys['KeyW']) dir.z -= 1;
          if (this.keys['KeyS']) dir.z += 1;
          if (this.keys['KeyA']) dir.x -= 1;
          if (this.keys['KeyD']) dir.x += 1;

          if (dir.lengthSq() > 0) {
            dir.normalize();
            // appliquer orientation de la caméra (seulement yaw)
            let camRot = this.cam.object3D.rotation.y;
            let rotMatrix = new THREE.Matrix4().makeRotationY(camRot);
            dir.applyMatrix4(rotMatrix);
            dir.multiplyScalar(this.data.maxSpeed);
          }

          // interpolation progressive
          this.velocity.x += (dir.x - this.velocity.x) * (dir.lengthSq() > 0 ? this.data.accel : this.data.decel);
          this.velocity.z += (dir.z - this.velocity.z) * (dir.lengthSq() > 0 ? this.data.accel : this.data.decel);

          // saut
          if (this.keys['Space'] && this.canJump) {
            body.velocity.y = this.data.jump;
            this.canJump = false;
          }

          // appliquer
          body.velocity.set(this.velocity.x, body.velocity.y, this.velocity.z);

          // caméra suit le cube
          this.cam.object3D.position.copy(this.el.object3D.position).add(new THREE.Vector3(0,1.5,0));
        }
      });
    </script>
  </body>
</html>

