<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>TP Web3D</title>
    
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.3.0/dist/aframe-physics-system.min.js"></script>

    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras/dist/aframe-extras.min.js"></script>
    
  </head>
  
  <body style="margin:0; overflow:hidden;">
    
    <a-scene physics="debug: true">
      
      <a-assets>
        <img id="sky" src="sky.jpg">
        <img id="grass" src="grass.jpg">
      </a-assets>
      
      <a-sky src="#sky"></a-sky>
      
      <a-plane position="0 0 0" rotation="-90 0 0" width="400" height="400" src="#grass" static-body></a-plane>

      <a-box id="player" color="red" depth="1" height="1" width="1" position="0 0.5 0" dynamic-body cube-controls></a-box>

      <a-entity camera position="0 2 5" look-controls></a-entity>

      <script>
      AFRAME.registerComponent('cube-controls', {
        schema: {
          maxSpeed: {type: 'number', default: 5},
          accel: {type: 'number', default: 0.2},
          decel: {type: 'number', default: 0.1},
          jump: {type: 'number', default: 5}
        },
        init: function () {
          this.keys = {};
          this.velocity = new THREE.Vector3(0, 0, 0);
          this.canJump = false;

          window.addEventListener('keydown', e => this.keys[e.code] = true);
          window.addEventListener('keyup', e => this.keys[e.code] = false);

          this.el.addEventListener('collide', e => {
            // si collision par dessous => sol
            if (e.detail.contact.ni.y > 0.5) this.canJump = true;
          });
        },
        tick: function () {
          const body = this.el.body;
          if (!body) return;

          // Cibles de mouvement (direction demandée par les touches)
          let targetX = 0, targetZ = 0;
          if (this.keys['KeyW']) targetZ -= this.data.maxSpeed;
          if (this.keys['KeyS']) targetZ += this.data.maxSpeed;
          if (this.keys['KeyA']) targetX -= this.data.maxSpeed;
          if (this.keys['KeyD']) targetX += this.data.maxSpeed;

          // Interpolation progressive (accélération/décélération)
          this.velocity.x += (targetX - this.velocity.x) * (targetX ? this.data.accel : this.data.decel);
          this.velocity.z += (targetZ - this.velocity.z) * (targetZ ? this.data.accel : this.data.decel);

          // Saut
          if (this.keys['Space'] && this.canJump) {
            body.velocity.y = this.data.jump;
            this.canJump = false;
          }

          // Application au corps physique
          body.velocity.set(this.velocity.x, body.velocity.y, this.velocity.z);
        }
      });

      document.querySelector('#player').setAttribute('cube-controls','');
    </script>
      
    </a-scene>
  </body>
  
</html>
